#!/bin/sh
set -e

echo "â³ Waiting for MySQL"

until php -r "
try {
    \$pdo = new PDO(
        'mysql:host=' . getenv('DB_HOST') . ';dbname=' . getenv('DB_NAME'),
        getenv('DB_USER'),
        getenv('DB_PASSWORD')
    );
    exit(0);
} catch (Exception \$e) {
    exit(1);
}
"; do
  sleep 2
done

echo "âœ… MySQL is ready"

if [ ! -d "vendor" ]; then
  echo "ğŸ“¦ Installing composer dependencies..."
  composer install --no-interaction --prefer-dist
fi

echo "ğŸ—„ï¸ Running migrations..."
php bin/console doctrine:migrations:migrate --no-interaction || true

echo "ğŸš€ Starting Symfony server..."
exec symfony server:start --no-tls --allow-http --listen-ip=0.0.0.0 --port=8000 --no-ansi
