#!/bin/sh
set -e

echo "â³ Waiting for MySQL..."
until php -r "
try {
    new PDO(
        'mysql:host=' . getenv('DB_HOST') . ';dbname=' . getenv('DB_NAME'),
        getenv('DB_USER'),
        getenv('DB_PASSWORD')
    );
    echo 'MySQL ready';
} catch (Exception \$e) {
    exit(1);
}
"; do
  sleep 2
done

if [ ! -d "vendor" ]; then
  echo "ğŸ“¦ Installing composer dependencies..."
  composer install --no-interaction
fi

echo "ğŸ—„ï¸ Running migrations..."
php bin/console doctrine:migrations:migrate --no-interaction

echo "ğŸš€ Starting Symfony server..."
exec symfony server:start --no-tls --allow-http --port=8000
